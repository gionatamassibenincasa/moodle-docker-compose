# [Full Stack Apache2 Moodle per tutti con Docker Compose](https://github.com/damalis/full-stack-apache2-moodle-for-everyone-with-docker-compose)

Se vorrai costruire una sito con Moodle **moodle** in tempo breve;

#### Full stack Apache2 Moodle "moodle":
<p align="left">
<a href="https://moodle.org/" target="_blank" rel="noreferrer"> <img src="https://avatars.githubusercontent.com/u/168672?s=200&v=4" alt="Moodle" height="40" width="40"/> </a>&nbsp;&nbsp;&nbsp; 
<a href="https://www.docker.com/" target="_blank" rel="noreferrer"> <img src="https://raw.githubusercontent.com/github/explore/80688e429a7d4ef2fca1e82350fe8e3517d3494d/topics/docker/docker.png" alt="docker" width="40" height="40" width="40"/> </a>&nbsp;&nbsp;&nbsp; 
<a href="https://mariadb.org/" target="_blank" rel="noreferrer"> <img src="https://avatars.githubusercontent.com/u/5877084?s=200&v=4" alt="mariadb" height="50" width="50"/> </a>&nbsp;&nbsp;&nbsp; 
<a href="https://dev.mysql.com/" target="_blank" rel="noreferrer"> <img src="https://avatars.githubusercontent.com/u/2452804?s=200&v=4" alt="mysql" height="50" width="50"/> </a>&nbsp;&nbsp;&nbsp; 
<a href="https://www.apache.org/" target="_blank" rel="noreferrer"> <img src="https://avatars.githubusercontent.com/u/47359?s=200&v=4" alt="apache2" height="40" width="40"/> </a>&nbsp;&nbsp;&nbsp; 
<a href="https://www.php.net" target="_blank" rel="noreferrer"> <img src="https://avatars.githubusercontent.com/u/25158?s=200&v=4" alt="php" height="40" width="40"/> </a>&nbsp;&nbsp;&nbsp; 
<a href="https://redis.io" target="_blank" rel="noreferrer"> <img src="https://avatars.githubusercontent.com/u/1529926?s=200&v=4" alt="redis" height="40" width="40"/> </a>&nbsp;&nbsp;&nbsp; 
<a href="#" target="_blank" rel="noreferrer"> <img src="https://raw.githubusercontent.com/github/explore/80688e429a7d4ef2fca1e82350fe8e3517d3494d/topics/bash/bash.png" alt="Bash" height="50" width="50" /> </a>&nbsp;&nbsp;&nbsp; 
<a href="https://www.phpmyadmin.net/" target="_blank" rel="noreferrer"> <img src="https://avatars.githubusercontent.com/u/1351977?s=200&v=4" alt="phpmyadmin" height="40" width="40"/> </a>&nbsp;&nbsp;&nbsp; 
<a href="https://certbot.eff.org/" target="_blank" rel="noreferrer"> <img src="https://avatars.githubusercontent.com/u/17889013?s=200&v=4" alt="certbot" height="40" width="40"/> </a>&nbsp;&nbsp;&nbsp; 
<a href="https://letsencrypt.org/" target="_blank" rel="noreferrer"> <img src="https://avatars.githubusercontent.com/u/9289019?s=200&v=4" alt="letsencrypt" height="40" width="40"/> </a>&nbsp;&nbsp;&nbsp; 
<a href="https://www.portainer.io/?hsLang=en" target="_blank" rel="noreferrer"> <img src="https://avatars.githubusercontent.com/u/22225832?s=200&v=4" alt="portainer" height="40" width="40"/> </a>&nbsp;&nbsp;&nbsp; 
<a href="https://github.com/mailhog" target="_blank" rel="noreferrer"> <img src="https://avatars.githubusercontent.com/u/10258541?s=200&v=4" alt="mailhog" height="40" width="40"/> </a>&nbsp;&nbsp;&nbsp; 
<a href="https://www.offen.dev/" target="_blank" rel="noreferrer"> <img src="https://avatars.githubusercontent.com/u/47735043?s=200&v=4" alt="backup" height="35" width="35"/> </a>
</p>


In più, gestisci container Docker con Portainer.

#### Architetture CPU supportate:
<p align="left"> arm64/aarch64, x86-64 </p>


#### Gestori pacchetti Linux supportati:
<p align="left"> apk, dnf, yum, apt/apt-get, zypper, pacman </p>


#### Distribuzioni Linux supportate:
<p align="left">
<a href="https://alpinelinux.org/" target="_blank" rel="noreferrer"> <img src="https://avatars.githubusercontent.com/u/7600810?s=200&v=4" alt="alpine linux" height="40" width="40"/> </a>&nbsp;&nbsp;&nbsp; 
<a href="https://fedoraproject.org/" target="_blank" rel="noreferrer"> <img src="https://raw.githubusercontent.com/github/explore/e6b1e7f0fb8d0bf920bd719c7289243138bdc1b4/topics/fedora/fedora.png" alt="fedora" height="40" width="40"/> </a>&nbsp;&nbsp;&nbsp; 
<a href="https://www.centos.org/" target="_blank" rel="noreferrer"> <img src="https://avatars.githubusercontent.com/u/79192?s=200&v=4" alt="centos" height="40" width="40"/> </a>&nbsp;&nbsp;&nbsp; 
<a href="https://www.debian.org/" target="_blank" rel="noreferrer"> <img src="https://avatars.githubusercontent.com/u/1854028?s=200&v=4" alt="debian" height="40" width="40"/> </a>&nbsp;&nbsp;&nbsp; 
<a href="https://ubuntu.com/" target="_blank" rel="noreferrer"> <img src="https://avatars.githubusercontent.com/u/4604537?s=200&v=4" alt="ubuntu" height="40" width="40"/> </a>&nbsp;&nbsp;&nbsp; 
<a href="https://www.raspberrypi.com/" target="_blank" rel="noreferrer"> <img src="https://avatars.githubusercontent.com/u/1294177?s=200&v=4" alt="ubuntu" height="40" width="40"/> </a>&nbsp;&nbsp;&nbsp; 
<a href="https://www.redhat.com/en/technologies/linux-platforms/enterprise-linux" target="_blank" rel="noreferrer"> <img src="https://avatars.githubusercontent.com/u/33972111?s=200&v=4" alt="redhat on s390x (IBM Z)" height="40" width="40"/> </a>&nbsp;&nbsp;&nbsp; 
<a href="https://www.suse.com/products/server/" target="_blank" rel="noreferrer"> <img src="https://avatars.githubusercontent.com/u/623819?s=200&v=4" alt="opensuse on s390x (IBM Z)" height="40" width="40"/> </a>&nbsp;&nbsp;&nbsp; 
<a href="https://archlinux.org/" target="_blank" rel="noreferrer"> <img src="https://gitlab.archlinux.org/uploads/-/system/group/avatar/23/iconfinder_archlinux_386451.png?width=48" alt="arch linux" height="40" width="40"/> </a>
</p>


##### Note: Compatibile con Fedora 37, 39 e alpine linux x86-64, non è stato possibile provare SLES per il sistema su IBM Z (s390x), RHEL per il sistema su IBM Z (s390x) e Raspberry Pi.

#### Con questo progetto puoi eseguire:

- [Moodle](https://github.com/moodle) - [php-fpm](https://hub.docker.com/_/php?tab=tags&page=1&name=fpm)
- [webserver (apache2/httpd)](https://hub.docker.com/_/httpd)
- [certbot (letsencrypt)](https://hub.docker.com/r/certbot/certbot)
- [phpMyAdmin](https://hub.docker.com/r/phpmyadmin/phpmyadmin/)
- [Mariadb](https://hub.docker.com/_/mariadb) [Mysql](https://hub.docker.com/_/mysql)
- [redis](https://hub.docker.com/_/redis)
- [mailhog](https://github.com/mailhog)
- [backup](https://hub.docker.com/r/offen/docker-volume-backup)

#### Per il certificato di certbot (letsencrypt):

- [Configura la configurazione del DNS per il tuo nome di dominio](https://support.google.com/a/answer/48090?hl=en)

#### Firewall IPv4/IPV6
Crea regole per aprire porte verso il web, o ad un indirizzo IP v4 specifico o ranges.

- http: 80
- https: 443
- portainer: 9001
- phpmyadmin: 9090

#### Indice:

- [Auto Configurazione e Installazione](#configurazione_automatica)
- [Configurazione Manuale e Installazione](#manuale)
  - [Requisiti](#requisiti)
  - [Configurazione](#configurazione)
  - [Installazione](#installazione)
- [Installazione di Portainer](#portainer)
- [Uso](#uso)
  - [Sito Web](#sito-web)
  - [Server Web](#server-web)
  - [Redis](#redis-1)
  - [Mail](#mail-1)
  - [phpMyAdmin](#phpmyadmin-1)
  - [Backup](#backup)

### Configurazione Automatica

#### Esecuzione del shell script per l'installazione e configurazione automatiche

download con

```
git clone https://github.com/gionatamassibenincasa/moodle-docker-compose.git
```

Apri una finestra del terminale e `cd` nel directory in cui `docker-compose.yml` è salvato ed esegui:

```
cd moodle-docker-compose
chmod +x install.sh
./install.sh
```

### Manuale

#### Requisiti

Assicurati di avere le versioni più recenti di **Docker** e **Docker Compose** installate sul tuo dispositivo e richiedano fino a 2 GB di memoria.

- [Come installare docker](https://docs.docker.com/engine/install/)
- [Come installare docker compose](https://docs.docker.com/compose/install/)

Copia questo repository o clona i file da questo repository in una nuova directory.

Assicurati di aggiungere il tuo utente al gruppo `docker` [come descritto qui](https://docs.docker.com/install/linux/linux-postinstall/#manage-docker-as-a-non-root-user).

#### Configurazione

download con
```
git clone https://github.com/gionatamassibenincasa/moodle-docker-compose.git
```

Apri una terminale e scendi nel directory in cui si trova il file `docker-compose.yml`, quindi esegui:
```
cd /path/to/folder
docker-compose
``` 
Sostituisci `/path/to/folder` con la path reale al tuo folder.

```
cd moodle-docker-compose
```

Copia l'esempio dell'ambiente nel file `.env`

```
cp env.example .env
```

Modifica il file `.env` per cambiare i valori di

|`LOCAL_TIMEZONE`|`DOMAIN_NAME`|`DIRECTORY_PATH`|`LETSENCRYPT_EMAIL`|
|`DB_USER`|`DB_PASSWORD`|`DB_NAME`|`DB_TABLE_PREFIX`|`MYSQL_ROOT_PASSWORD`|`DATABASE_IMAGE_NAME`|
|`DATABASE_CONT_NAME`|`DATABASE_PACKAGE_MANAGER`|`DATABASE_ADMIN_COMMANDLINE`|`PMA_CONTROLUSER`|`PMA_CONTROLPASS`|
|`PMA_HTPASSWD_USERNAME`|`PMA_HTPASSWD_PASSWORD`|`SSL_SNIPPET`|

<table><thead>
  <tr>
    <th>Variable </th>
    <th colspan="2">Value</th>
  </tr></thead>
<tbody>
  <tr>
    <td><code>LOCAL_TIMEZONE</code></td>
    <td colspan="2"><code><a href="https://en.wikipedia.org/wiki/List_of_tz_database_time_zones#List" rel="nofollow">to see local timezones</a></code></td>
  </tr>
  <tr>
    <td><code>DIRECTORY_PATH</code></td>
    <td colspan="2"><code>pwd</code> at command line</td>
  </tr>
  <tr>
    <td><code>DB_TABLE_PREFIX</code></td>
    <td colspan="2"><code>mdl_</code> or <code><a href="https://mariadb.com/docs/server/reference/sql-structure/sql-language-structure/identifier-names" rel="nofollow" alt="custom value">custom value</a></code></td>
  </tr>
  <tr>
    <td><code>DATABASE_IMAGE_NAME</code></td>
    <td colspan="2"><code>mariadb</code> or <code>mysql</code></td>
  </tr>
  <tr>
    <td><code>DATABASE_CONT_NAME</code></td>
    <td colspan="2"><code>mariadb</code>, <code>mysql</code> or <code><a href="https://docs.docker.com/reference/compose-file/services/#container_name" rel="nofollow" alt="custom name">custom name</a></code></td>
  </tr>
  <tr>
    <td rowspan="2"><code>DATABASE_PACKAGE_MANAGER</code></td>
    <td>mariadb</td>
    <td><code>apt-get update && apt-get install -y gettext-base</code></td>
  </tr>
  <tr>
    <td>mysql</td>
    <td><code>microdnf install -y gettext</code></td>
  </tr>
  <tr>
    <td rowspan="2"><code>DATABASE_ADMIN_COMMANDLINE</code></td>
    <td>mariadb</td>
    <td><code>mariadb-admin</code></td>
  </tr>
  <tr>
    <td>mysql</td>
    <td><code>mysqladmin</code></td>
  </tr>
  <tr>
    <td rowspan="2"><code>SSL_SNIPPET</code></td>
    <td>localhost</td>
    <td><code>echo 'Generated Self-signed SSL Certificate at localhost'</code></td>
  </tr>
  <tr>
    <td>remotehost</td>
    <td><code>certbot certonly --webroot --webroot-path /tmp/acme-challenge --rsa-key-size 4096 --non-interactive --agree-tos --no-eff-email --force-renewal --email ${LETSENCRYPT_EMAIL} -d ${DOMAIN_NAME} -d www.${DOMAIN_NAME} -d mail.${DOMAIN_NAME}</code></td>
  </tr>
</tbody>
</table>


e

```
cp ./webserver/extra/httpd-ssl.conf.template ./webserver/extra/httpd-ssl.conf
```

cambia `example.com` col nome del tuo dominio nel file `./webserver/extra/httpd-ssl.conf`.

```
cp ./phpmyadmin/apache2/sites-available/default-ssl.sample.conf ./phpmyadmin/apache2/sites-available/default-ssl.conf
```

cambia `example.com` col nome del tuo dominio nel file `./phpmyadmin/apache2/sites-available/default-ssl.conf`.
```
cp ./database/phpmyadmin/sql/create_tables.sql.template.example ./database/phpmyadmin/sql/create_tables.sql.template
```

modifica `pma_controluser` e `db_authentication_password` nel file `./database/phpmyadmin/sql/create_tables.sql.template`.

#### Installazione

Prima di tutto: verrà creato unVolume esterno

```
docker volume create --driver local --opt type=none --opt device=${PWD}/certbot --opt o=bind certbot-etc
```

Localhost SSL: Genera un Certificato SSL auto-firmato come da guida [mkcert](https://github.com/FiloSottile/mkcert).

```
docker compose up -d
```

quindi ricarica la configurazione SSL del server web

```
docker container restart webserver
```

I container sono stati compilati e stanno eseguendo.
Ora dovresti essere in grado di accedere all'istanza di Moodle attraverso il browser, utilizzando l'IP configurato nella barra degli indirizzi.

Per convenienza puoi aggiungere una nuova entry al tuo file `/etc/hosts`.

### Portainer

```
docker compose -f portainer-docker-compose.yml -p portainer up -d 
```
gestisci Docker con [Portainer](https://www.portainer.io/), è uno strumento di gestione dei contenitori per Docker, compatibile con Docker Swarm grazie alla sua interfaccia utente e alle API.

Puoi anche visitare [https://example.com:9001](https://example.com:9001) per accedere a Portainer dopo aver avviato i container.

### Uso



#### Ecco una riferimento veloce ai comuni comandi di Docker Compose

```
docker ps -a	# Lists all containers managed by the compose file
```

```
docker compose start	# Starts previously stopped containers
```

```
docker compose stop	# Stops all running containers
```

```
docker compose down	# Stops and removes containers, networks, etc.
```

```
docker compose down -v # Add --volumes to remove volumes explicitly
```

```
docker rm -f $(docker ps -a -q)	# Removes portainer and the other containers
```

```
docker volume rm $(docker volume ls -q)	# Removes all volumes
```

```
docker network prune	# Remove all unused networks
```

```
docker system prune	# Removes unused data (containers, networks, images, and optionally volumes)
```

```
docker system prune -a	# Removes all unused images, not just dangling ones
```

```
docker rmi $(docker image ls -q)	# Removes portainer and the other images
```

```
docker container logs container_name_or_id	# Shows logs from all services
```

#### Progetto da sorgente esistente

Copia tutti i file in una nuova directory:

```
docker compose up -d	# Starts services in detached mode (in the background)
```

#### Riferumento a Docker run

[https://docs.docker.com/reference/cli/docker/compose/](https://docs.docker.com/reference/cli/docker/compose/)

#### Sito Web

Selezionate la pagina "Home" nel vostro browser. Se non è visibile, verificate se l'installazione di PHP soddisfa le esigenze di Moodle.

```
https://example.com
```

```
Username: admin
Password: admin123
```

Aggiungi o rimuovi codice nel file `./php-fpm/php/conf.d/security.ini` per configurazioni personalizzate del file `php.ini`


[https://www.php.net/manual.en.configuration.file.php](https://www.php.net/manual/en/configuration.file.php)

Dovresti fare modifiche alle configurazioni personalizzate del host `[./php-fpm/php-fpm.d/z-www.conf]`, quindi dovrai riavviare il servizio. FPM utilizza la sintassi di `php.ini` per il suo file di configurazione - `php-fpm.conf`, e i files di configurazione delle pool di processo.

[https://www.php.net/manual/en/install.fpm.configuration.php](https://www.php.net/manual/en/install.fpm.configuration.php)

```
docker container restart moodle
```

aggiungi o rimuovi le cartelle e i file del sito Moodle con qualsiasi programma di gestione FTP nella directory `/./moodle/moodle`.
<br />Puoi anche accedere alla pagina web attraverso `https://example.com` dopo aver avviato i container.

#### Web server

aggiungi o rimuovi codice nel file `./webserver/extra/httpd-ssl.conf` per configurazioni personalizzate di Apache2/HTTPd.

[https://httpd.apache.org/docs/2.4/](https://httpd.apache.org/docs/2.4/)

#### Redis

```
// Set local cache dir for pod's tmp folder
$CFG->localcachedir = '/tmp/moodle';

//   Redis session handler (requires redis server and redis extension):
$CFG->session_handler_class = '\core\session\redis';
$CFG->session_redis_host = 'redis';
$CFG->session_redis_port = 6379;                     // Optional.
$CFG->session_redis_database = 0;                    // Optional, default is db 0.
$CFG->session_redis_auth = '';                       // Optional, default is don't set one.
$CFG->session_redis_prefix = '';                     // Optional, default is don't set one.
$CFG->session_redis_acquire_lock_timeout = 120;      // Default is 2 minutes.
$CFG->session_redis_acquire_lock_warn = 0;           // If set logs early warning if a lock has not been acquried.
$CFG->session_redis_lock_expire = 7200;              // Optional, defaults to session timeout.
$CFG->session_redis_lock_retry = 100; 
```

aggiungi il codice sopra nel file `./moodle/moodle/config.php`.

[https://docs.moodle.org/500/en/Redis_cache_store#Configuring_Redis_in_Moodle](https://docs.moodle.org/500/en/Redis_cache_store#Configuring_Redis_in_Moodle)

#### Mail

SMTP impostazioni: |`Host: mail, Port: 1025`|

La schermata di autorizzazione, **username**: `${PMA_HTPASSWD_USERNAME}` e **password**: `${PMA_HTPASSWD_PASSWORD}` nel file `.env`.

#### phpMyAdmin

Puoi aggiungere le proprie impostazioni personalizzate del file `config.inc.php` (`es. Configurazione di Archiviazione`) creando un file chiamato `config.user.inc.php` con le diverse impostazioni definite dal utente, e poi collegarlo al contenitore utilizzando:

```
./phpmyadmin/config.user.inc.php
```


Il primo schermo di autorizzazione (htpasswd;username o password) e il schermo di accesso a phpMyAdmin usano lo stesso nome utente e password forniti nel file `.env`.

#### backup

Questo farà il restore di tutti i files e sottocartelle nel database/dump sql e html volumi, una sola volta al giorno, e scriverà in `/./backups` con un nome del file come backup-2023-01-01T10-18-00.tar.gz

##### può eseguirsi su un orario cron personalizzato

`BACKUP_CRON_EXPRESSION: '20 01 * * *'` nel orario UTC.
